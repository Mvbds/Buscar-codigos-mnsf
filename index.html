<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MNSF Codigos</title>

  <link rel="manifest" href="/manifest.json" />
  <meta name="theme-color" content="#ff3b3b" />

  <style>
    :root{
      --primary:#e53935; /* vermelho similar √† logo */
      --accent:#ffc107;  /* amarelo */
      --bg:#fff;
      --muted:#6b7280;
      --card:#f8fafc;
      --radius:12px;
    }
    html,body{height:100%;margin:0;font-family:Inter,system-ui,Arial,sans-serif;background:linear-gradient(180deg,#fff 0%, #fffbf1 100%);}
    .app{max-width:880px;margin:0 auto;padding:14px;display:flex;flex-direction:column;min-height:100vh;box-sizing:border-box}
    header{display:flex;align-items:center;gap:12px;padding:12px;border-radius:14px;background:rgba(255,255,255,0.8);box-shadow:0 6px 18px rgba(0,0,0,0.06);backdrop-filter:blur(6px)}
    .logo{width:66px;height:66px;border-radius:999px;display:flex;align-items:center;justify-content:center;overflow:hidden}
    .logo img{width:100%;height:100%;object-fit:contain;display:block}
    h1{font-size:18px;margin:0;color:#111;font-weight:700}
    p.subtitle{margin:0;color:var(--muted);font-size:13px}

    .controls{margin-top:12px;display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .search{flex:1;min-width:160px}
    input.search-input{width:100%;padding:12px 14px;border-radius:10px;border:1px solid #e6e9ee;background:white;font-size:15px;box-shadow:0 1px 0 rgba(0,0,0,0.02)}
    select.cat-select{padding:10px 12px;border-radius:10px;border:1px solid #e6e9ee;background:white;font-size:14px}
    .btn{padding:10px 12px;border-radius:10px;background:var(--primary);color:white;font-weight:600;border:0;display:inline-flex;gap:8px;align-items:center}
    .btn.ghost{background:transparent;color:var(--primary);border:1px solid rgba(0,0,0,0.06)}
    .btn.small{padding:8px 10px;font-size:14px}

    main{margin-top:14px;flex:1}
    .list{display:flex;flex-direction:column;gap:10px}
    .category-title{margin:14px 0 6px;font-weight:700;color:#222}
    .card{display:flex;justify-content:space-between;align-items:center;padding:12px;border-radius:12px;background:var(--card);box-shadow:0 4px 12px rgba(0,0,0,0.03)}
    .left{display:flex;gap:12px;align-items:center}
    .prod-name{font-weight:700}
    .prod-code{font-family:monospace;color:var(--muted);font-size:13px;margin-top:4px}
    .actions{display:flex;gap:8px;align-items:center}
    .icon-btn{background:transparent;border:0;padding:8px;border-radius:8px;cursor:pointer}
    .icon-btn:hover{background:rgba(0,0,0,0.03)}

    .noresults{text-align:center;color:var(--muted);padding:28px 8px}

    /* modal */
    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.45);display:none;align-items:center;justify-content:center;z-index:40}
    .modal{background:white;padding:16px;border-radius:14px;max-width:460px;width:100%;box-shadow:0 10px 30px rgba(0,0,0,0.2)}
    .modal header{display:flex;align-items:center;gap:10px;margin-bottom:8px}
    .field{margin:8px 0}
    .field label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
    .field input,.field select{width:100%;padding:10px;border-radius:8px;border:1px solid #e6e9ee}
    .modal .row{display:flex;gap:8px}
    .modal .row .col{flex:1}
    .muted{color:var(--muted);font-size:13px}

    footer{margin-top:20px;text-align:center;color:var(--muted);font-size:13px;padding-bottom:20px}

    /* responsive */
    @media (max-width:640px){
      header{gap:10px;padding:10px}
      .logo{width:56px;height:56px}
      .btn{padding:9px 10px}
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div class="logo"><img src="./logo-mnsf.png" alt="MNSF logo" id="appLogo"></div>
      <div>
        <h1>MNSF C√≥digos</h1>
        <p class="subtitle">Busque produtos pelo nome ou c√≥digo ‚Äî todos salvam no Google Sheets</p>
      </div>
      <div style="margin-left:auto">
        <button id="installBtn" class="btn small" style="display:none">Instalar</button>
      </div>
    </header>

    <div class="controls">
      <div class="search">
        <input id="searchInput" class="search-input" placeholder="Pesquisar por nome ou c√≥digo..." />
      </div>

      <select id="categorySelect" class="cat-select" aria-label="Categoria">
        <option value="all">Todas as categorias</option>
      </select>

      <button id="addProductBtn" class="btn">+ Produto</button>
      <button id="addCategoryBtn" class="btn ghost">+ Categoria</button>
    </div>

    <main>
      <div id="contentArea" class="list"></div>
      <div id="noResults" class="noresults" style="display:none">Nenhum resultado encontrado</div>
    </main>

    <footer>Toque em compartilhar ‚Üí Adicionar √† Tela de In√≠cio para instalar (ou use o bot√£o instalar).</footer>
  </div>

  <!-- modal backdrop -->
  <div id="modalBackdrop" class="modal-backdrop">
    <div class="modal" role="dialog" aria-modal="true">
      <header>
        <strong id="modalTitle">Adicionar Produto</strong>
      </header>
      <div id="modalBody">
        <div class="field">
          <label>Categoria</label>
          <select id="modalCategory"></select>
        </div>
        <div class="field">
          <label>Nome do produto</label>
          <input id="modalName" type="text" placeholder="Ex: Cebola Branca" />
        </div>
        <div class="field">
          <label>C√≥digo</label>
          <input id="modalCode" type="text" placeholder="Ex: 37269" />
        </div>
        <div class="field muted">Os dados ser√£o salvos diretamente na planilha do Google (vis√≠vel a todos).</div>
      </div>
      <div style="display:flex;gap:8px;margin-top:10px;justify-content:flex-end">
        <button id="cancelModal" class="btn ghost">Cancelar</button>
        <button id="saveModal" class="btn">Salvar</button>
      </div>
    </div>
  </div>

<script>
/* ========== CONFIG ========== */
const API_URL = "https://script.google.com/macros/s/AKfycbzpPFyRFZLdyuw2xDOsRXmwv0VIp_3ZTltIrsPmgQJ6IcDGRWBiqinr6nXieGuC9XHG/exec";
/* ============================ */

let deferredPrompt = null;
window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault();
  deferredPrompt = e;
  const btn = document.getElementById('installBtn');
  btn.style.display = 'inline-flex';
  btn.addEventListener('click', async () => {
    btn.style.display = 'none';
    if (!deferredPrompt) return;
    deferredPrompt.prompt();
    const choice = await deferredPrompt.userChoice;
    deferredPrompt = null;
  });
});

const elems = {
  searchInput: document.getElementById('searchInput'),
  categorySelect: document.getElementById('categorySelect'),
  contentArea: document.getElementById('contentArea'),
  noResults: document.getElementById('noResults'),
  addProductBtn: document.getElementById('addProductBtn'),
  addCategoryBtn: document.getElementById('addCategoryBtn'),
  modalBackdrop: document.getElementById('modalBackdrop'),
  modalTitle: document.getElementById('modalTitle'),
  modalCategory: document.getElementById('modalCategory'),
  modalName: document.getElementById('modalName'),
  modalCode: document.getElementById('modalCode'),
  cancelModal: document.getElementById('cancelModal'),
  saveModal: document.getElementById('saveModal')
};

let APP_DATA = []; // loaded from Google Sheets
let CATEGORIES = [];

function normalize(s){ return (s||'').toString().normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase().trim(); }

/* fetch data from Google Apps Script */
async function loadData(){
  try {
    const res = await fetch(API_URL, {cache: "no-store"});
    if (!res.ok) throw new Error('Falha ao carregar dados: ' + res.status);
    const json = await res.json();
    // json expected array of objects {categoria,nome,codigo}
    APP_DATA = Array.isArray(json) ? json.map(r => ({
      categoria: (r.categoria || '').toString(),
      nome: (r.nome || '').toString(),
      codigo: (r.codigo || '').toString()
    })) : [];
    buildCategories();
    render();
  } catch(err){
    console.error(err);
    alert('Erro ao carregar dados. Verifique a implanta√ß√£o do Apps Script e se est√° p√∫blica.');
  }
}

/* derive categories (unique) */
function buildCategories(){
  const set = new Set();
  APP_DATA.forEach(r => {
    const c = (r.categoria||'').toString().trim();
    if (c) set.add(c);
  });
  // also include any category that user created during this session (stored in localStorage)
  const extra = JSON.parse(localStorage.getItem('extraCats')||'[]');
  extra.forEach(c => c && set.add(c));
  CATEGORIES = Array.from(set);
  // update select UI
  const sel = elems.categorySelect;
  const modalSel = elems.modalCategory;
  sel.innerHTML = '<option value="all">Todas as categorias</option>';
  modalSel.innerHTML = '';
  CATEGORIES.forEach(c => {
    const opt = document.createElement('option'); opt.value = c; opt.textContent = c; sel.appendChild(opt);
    const opt2 = document.createElement('option'); opt2.value = c; opt2.textContent = c; modalSel.appendChild(opt2);
  });
}

/* render products list according to search + category */
function render(){
  const q = normalize(elems.searchInput.value);
  const selected = elems.categorySelect.value;
  elems.contentArea.innerHTML = '';
  // group by category
  const grouped = {};
  APP_DATA.forEach(item => {
    // ignore rows where name is empty (these could be placeholder from creating category)
    if (!item.nome || item.nome.trim()==='') return;
    if (!grouped[item.categoria]) grouped[item.categoria]=[];
    grouped[item.categoria].push(item);
  });
  // create an array of categories to display (respect selected)
  const catsToShow = selected==='all' ? CATEGORIES : [selected];
  let totalShown = 0;
  catsToShow.forEach(cat => {
    const list = (grouped[cat] || []).filter(it => {
      if (!q) return true;
      return normalize(it.nome).includes(q) || (it.codigo||'').includes(q);
    });
    if (list.length===0) return;
    totalShown += list.length;
    const title = document.createElement('div');
    title.className = 'category-title';
    title.textContent = cat;
    elems.contentArea.appendChild(title);
    list.forEach(it => {
      const card = document.createElement('div');
      card.className = 'card';
      card.innerHTML = `
        <div class="left">
          <div style="width:44px;height:44px;border-radius:10px;background:linear-gradient(180deg,#fff,#f3f3f3);display:flex;align-items:center;justify-content:center;font-weight:700;color:var(--primary)">${cat[0]||'P'}</div>
          <div>
            <div class="prod-name">${it.nome}</div>
            <div class="prod-code">${it.codigo}</div>
          </div>
        </div>
        <div class="actions">
          <button title="Mostrar c√≥digo" class="icon-btn" onclick="copyCode('${(it.codigo||'').replace(/'/g,"\\'")}')">üìã</button>
          <button title="Editar" class="icon-btn" onclick="editItem('${(it.categoria||'').replace(/'/g,"\\'")}','${(it.nome||'').replace(/'/g,"\\'")}','${(it.codigo||'').replace(/'/g,"\\'")}')">‚úèÔ∏è</button>
        </div>
      `;
      elems.contentArea.appendChild(card);
    });
  });

  elems.noResults.style.display = totalShown>0 ? 'none' : 'block';
}

/* copy code to clipboard */
function copyCode(code){
  if (!code) return;
  navigator.clipboard?.writeText(code).then(()=>alert('C√≥digo copiado: ' + code));
}

/* open modal to add product */
function openAddModal(){
  elems.modalTitle.textContent = 'Adicionar Produto';
  elems.modalName.value = '';
  elems.modalCode.value = '';
  // ensure categories are updated
  buildCategories();
  elems.modalBackdrop.style.display = 'flex';
}

/* open modal to edit item (we will create a new row in sheet for edit - simple way is to create new row and optionally keep old) */
function editItem(categoria, nome, codigo){
  elems.modalTitle.textContent = 'Editar Produto (salvar cria nova entrada)';
  buildCategories();
  elems.modalCategory.value = categoria || (CATEGORIES[0]||'');
  elems.modalName.value = nome || '';
  elems.modalCode.value = codigo || '';
  elems.modalBackdrop.style.display = 'flex';
}

/* close modal */
function closeModal(){ elems.modalBackdrop.style.display='none'; }

/* show prompt to add category */
async function addCategoryPrompt(){
  const name = prompt('Nome da nova categoria:');
  if (!name) return;
  // save locally (so UI updates instantly) and also append a placeholder row to Google Sheets
  const extra = JSON.parse(localStorage.getItem('extraCats')||'[]');
  if (!extra.includes(name)) { extra.push(name); localStorage.setItem('extraCats', JSON.stringify(extra)); }
  buildCategories();
  // append placeholder row to sheet so category persists for everyone
  try {
    await postData({categoria: name, nome: '', codigo: ''});
    await loadData();
    alert('Categoria "'+name+'" adicionada.');
  } catch(e){ console.error(e); alert('Erro ao adicionar categoria.'); }
}

/* POST helper */
async function postData(obj){
  // Apps Script exec expects body sent as JSON ‚Äî we do that
  const res = await fetch(API_URL, {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify(obj)
  });
  if (!res.ok) throw new Error('Falha ao postar: '+res.status);
  return res.text();
}

/* save from modal */
async function saveFromModal(){
  const cat = elems.modalCategory.value || '';
  const nome = elems.modalName.value.trim();
  const codigo = elems.modalCode.value.trim();
  if (!cat) { alert('Escolha uma categoria'); return; }
  if (!nome) { alert('Preencha o nome do produto'); return; }
  if (!codigo) { if(!confirm('C√≥digo vazio. Deseja prosseguir?')) return; }
  try {
    await postData({categoria: cat, nome, codigo});
    closeModal();
    await loadData();
    alert('Produto salvo.');
  } catch(err) {
    console.error(err);
    alert('Erro ao salvar produto.');
  }
}

/* events */
elems.searchInput.addEventListener('input', render);
elems.categorySelect.addEventListener('change', render);
elems.addProductBtn.addEventListener('click', openAddModal);
elems.addCategoryBtn.addEventListener('click', addCategoryPrompt);
elems.cancelModal.addEventListener('click', closeModal);
elems.saveModal.addEventListener('click', saveFromModal);

/* initial load */
loadData();

/* expose some functions for inline handlers */
window.copyCode = copyCode;
window.editItem = editItem;
</script>

</body>
</html>
